var request = require('request');
var langCodes=require('./langCodes.js');
var chalk=require('chalk');


/////////important settings for network optimization and solving stuck///////////////
var trial=0;
var trial_limit=25;
var delay_between_each_trial=1000;
var time_out_request=18000;
///////////////////////////////




      // gets if the search was on release or title....
function determineSubtitleSearch(fileName,lang, callback) {
  var domain = 'http://subscene.com',url = domain+'/subtitles/title?q='
  +encodeURIComponent(fileName);
  var r=  request({
    maxSockets:100,
      url: url,
      timeout:time_out_request,
      headers: {

        'User-Agent': 'Mozilla/5.0',
        //url=subscene.com/subtitles/release?q=
        'Cookie':'LanguageFilter='+langCodes[lang]

      }
    }, function (error, response, body) {


      var searchType=r.uri["pathname"].split('/')[2];


      if (!error && response.statusCode === 200 ) {
  

          callback(false,searchType,response,body,callback);

          return;

        }
        else{


          if(trial===trial_limit){
            callback(true);
            return;
          }
          trial=trial+1;
          //delay_between_each_trial=delay_between_each_trial*trial; //increase delay after each new trial to give the server some time to heal;;;
          setTimeout(function () {


          determineSubtitleSearch(fileName,lang, callback);
          return;
        }, delay_between_each_trial);
        }





});
};


module.exports=determineSubtitleSearch;
